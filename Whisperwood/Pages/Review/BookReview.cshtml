@page "{bookId:guid}"
@model Whisperwood.Pages.Review.BookReviewModel
@{
    Layout = "_Layout";
    ViewData["Title"] = "Book Reviews";
}
<div class="px-6 py-8">
    <h1 id="book-title" class="text-3xl font-bold text-center text-accent4 mb-6">Book Reviews</h1>

    <div class="text-center mb-6">
        <a href="/Book/Details/@Model.BookId" class="text-accent2 underline hover:text-accent3">← Back to Book</a>
    </div>

    
    <div id="review-list" class="space-y-4 max-w-4xl mx-auto"></div>
    <p id="no-reviews" class="text-center text-accent2 hidden">No reviews yet for this book.</p>

    <div class="text-center mt-6">
        <a href="/Review/AddReview?bookId=@Model.BookId" class="bg-accent3 text-white px-6 py-2 rounded hover:bg-accent2 transition">Write a Review</a>
    </div>
</div>

@section Scripts {
    <script>
        const bookId = "@Model.BookId";

        async function loadBookDetails() {
            const res = await fetch(`https://localhost:7018/api/Book/getbyid/${bookId}`);
            if (res.ok) {
                const book = await res.json();
                const authorNames = book.authorBooks.map(a => a.author.name).join(", ");
                document.getElementById("book-title").textContent = `Reviews for "${book.title}" by ${authorNames}`;
            }
        }

        async function loadReviews() {
            const res = await fetch(`https://localhost:7018/api/Review/book/${bookId}`);
            const reviews = await res.ok ? await res.json() : [];

            const list = document.getElementById("review-list");
            const noData = document.getElementById("no-reviews");

            list.innerHTML = "";

            if (reviews.length === 0) {
                noData.classList.remove("hidden");
                return;
            }

            reviews.forEach(r => {
                const div = document.createElement("div");
                div.className = "bg-primary border border-accent1 rounded p-4 shadow-md";
                div.innerHTML = `
                        <p class="text-sm text-accent1 mb-1">By <strong>${r.users?.name || "Anonymous"}</strong></p>
                        <p class="text-accent3 mb-1">Rating: ★ ${r.rating}</p>
                        <p class="text-accent2 italic mb-2">"${r.message}"</p>
                        <p class="text-xs text-gray-500">Posted: ${new Date(r.createdAt).toLocaleDateString()}</p>
                        ${r.updatedAt ? `<p class="text-xs text-gray-400">Updated: ${new Date(r.updatedAt).toLocaleDateString()}</p>` : ""}
                    `;
                list.appendChild(div);
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadBookDetails();
            loadReviews();
        });
    </script>
}
