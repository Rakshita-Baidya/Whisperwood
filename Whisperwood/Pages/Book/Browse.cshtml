@page
@model Whisperwood.Pages.Book.BrowseModel

@{
    Layout = "_Layout";
    ViewData["Title"] = "Browse Books";
}

<div class="px-4 py-8">
    <h1 class="text-accent3 mb-6 text-center text-4xl font-bold">Browse Books</h1>

    <div id="error-message" class="mb-4 hidden text-center text-red-600"></div>

    <div id="books-container" class="grid grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
        <!-- Books will be injected here by JavaScript -->
        <div id="loading" class="text-accent2 col-span-full text-center text-lg">Loading books...</div>
    </div>

    <div id="no-books" class="text-accent2 mt-4 hidden text-center text-lg">No books found.</div>
</div>

@section Scripts {
    <script>
        async function fetchBooks() {
            const booksContainer = document.getElementById('books-container');
            const loadingElement = document.getElementById('loading');
            const noBooksElement = document.getElementById('no-books');
            const errorMessageElement = document.getElementById('error-message');
            const token = localStorage.getItem('token');

            let wishlistItems = [];
            if (token) {
                try {
                    const wishlistResponse = await fetch('https://localhost:7018/api/WishlistItem/getall', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (wishlistResponse.ok) {
                        wishlistItems = await wishlistResponse.json();
                    }
                } catch (error) {
                    console.error('Failed to fetch wishlist:', error);
                }
            }


            try {
                const response = await fetch('https://localhost:7018/api/Book/getall');
                if (!response.ok) {
                    throw new Error('Failed to load books. Please try again later.');
                }

                const books = await response.json();
                loadingElement.classList.add('hidden');

                if (books && books.length > 0) {
                    books.forEach(book => {
                        const authorNames = book.authorBooks && book.authorBooks.length > 0
                            ? book.authorBooks.map(ab => ab.author.name).join(', ')
                            : 'Unknown Author';

                        const bookElement = document.createElement('a');
                        bookElement.href = `/Book/Details/${book.id}`;
                        bookElement.className = 'block bg-primary border-accent1 rounded-lg border-[2px] p-4 shadow-md transition-shadow hover:shadow-xl';
                        bookElement.innerHTML = `
                            ${book.coverImage && book.coverImage.coverImageURL
                                ? `<img src="${book.coverImage.coverImageURL}" alt="${book.title}" class="mb-4 h-64 w-full rounded-md object-cover" />`
                                : `<div class="text-accent3 mb-4 h-64 w-full">No Image</div>`
                            }
                            <h2 class="text-accent3 text-xl font-semibold">${book.title}</h2>
                            <p class="text-accent3 flex items-center">
                                <svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#ab7640" d="M22 10.1c.1-.5-.3-1.1-.8-1.1l-5.7-.8L12.9 3c-.1-.2-.2-.3-.4-.4-.5-.3-1.1-.1-1.4.4L8.6 8.2 2.9 9q-.45 0-.6.3c-.4.4-.4 1 0 1.4l4.1 4-1 5.7c0 .2 0 .4.1.6.3.5.9.7 1.4.4l5.1-2.7 5.1 2.7c.1.1.3.1.5.1h.2c.5-.1.9-.6.8-1.2l-1-5.7 4.1-4c.2-.1.3-.3.3-.5"/></svg>
                                ${book.averageRating}
                            </p>
                            <div class="mb-3 flex justify-between">
                                <p class="text-accent1 font-medium">${authorNames}</p>
                                <p class="text-accent1 font-medium">Rs. ${book.price.toFixed(2)}</p>
                            </div>
                            <div class="flex justify-between gap-2">
                                <button onclick="handleWishlist('${book.id}', event)" class="bg-accent3 rounded px-3 py-1 text-white hover:bg-accent2">Wishlist</button>
                                <button onclick="handleReview('${book.id}', event)" class="bg-accent3 rounded px-3 py-1 text-white hover:bg-accent2">Review</button>
                                <button onclick="handleAddToCart('${book.id}', event)" class="bg-accent3 rounded px-3 py-1 text-white hover:bg-accent2">Cart</button>
                            </div>
                        `;
                        booksContainer.appendChild(bookElement);
                    });
                } else {
                    noBooksElement.classList.remove('hidden');
                }
            } catch (error) {
                loadingElement.classList.add('hidden');
                errorMessageElement.textContent = error.message;
                errorMessageElement.classList.remove('hidden');
            }
        }

        // Call fetchBooks when the page loads
        document.addEventListener('DOMContentLoaded', fetchBooks);
    </script>
}